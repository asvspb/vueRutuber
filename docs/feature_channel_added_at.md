# Архитектурный план: Отображение времени добавления видео в канал Rutube

## Цель

Отображать на фронтенде реальное время добавления видео в канал Rutube (дату публикации видео на канале), используя поле из Rutube API (`created_ts`), а не время добавления записи в нашу БД.

## Определения
- Время добавления в канал (далее: «публикация на канале») — дата/время публикации видео на Rutube, приходит из Rutube API в поле `created_ts`.
- Время добавления в систему — момент сохранения записи в нашу БД (сейчас хранится в `movies.added_at` через `default=func.now()`).

## Текущее состояние (анализ)
- Backend:
  - Модель `Movie` (SQLAlchemy) содержит `added_at = Column(DateTime, default=func.now())` — это время добавления в нашу систему, не Rutube.
  - Скрапер `rutube_api_scraper.py` получает `created_ts` и сохраняет только производные поля (например, `year`), но сам `created_ts` в БД не сохраняет.
  - Pydantic-схема `Movie` возвращает `added_at` (время БД), что не совпадает с требованием «время добавления в канал».
- Frontend:
  - Интерфейс и компоненты готовы принять и отобразить строковое поле даты, но сейчас нет отдельного поля для публикации на канале.

Вывод: существует семантическая путаница между «added_at (в БД)» и «created_ts (на Rutube)». Для корректности лучше не менять смысл существующего `added_at`, а добавить отдельное поле под публикацию.

## Варианты реализации

1) Переопределить смысл `added_at` и хранить там дату публикации Rutube
   - Плюсы: меньше полей.
   - Минусы: меняется смысл существующего поля; возможны поломки логики/фильтров/сортировок, завязанных на «время добавления в систему»; миграция данных неоднозначна.

2) Добавить новое поле `channel_added_at` (рекомендуется)
   - Плюсы: чёткое разделение смыслов; обратная совместимость; контролируемая миграция.
   - Минусы: +1 поле и миграция.

Предлагаемое решение: Вариант 2 (новое поле `channel_added_at`).

## Изменения по слоям

### 1. Данные и модель БД
- Добавить в модель `Movie` новое поле:
  - `channel_added_at = Column(DateTime(timezone=True), nullable=True, index=True)`
- Индекс по полю упростит сортировку «новые на канале».
- Оставить `added_at` как есть (время добавления записи в систему).

Миграция БД:
- В проекте нет Alembic; используем синхронный engine `SyncSessionLocal`/`sync_engine` для одноразовой миграции (DDL):
  - ALTER TABLE movies ADD COLUMN channel_added_at TIMESTAMP WITH TIME ZONE NULL;
  - При необходимости создать индекс: CREATE INDEX IF NOT EXISTS ix_movies_channel_added_at ON movies (channel_added_at);
- Бэкофлайн-скрипт для бэкапа не требуется для dev, но для прод рекомендуется.

Бэкфилл исторических данных:
- Для уже сохранённых видео при наличии `source_url` и отсутствия `channel_added_at` можно (необязательно) пробежать по API Rutube повторно и заполнить `channel_added_at` из `created_ts`. Это отдельная задача/команда.

### 2. Scraper (rutube_api_scraper.py)
- В `fetch_channel_videos` уже приходит поле `created_ts`.
- В `save_videos_to_db` при создании записи `Movie` дополнительно сохранять:
  - `channel_added_at`: parse `created_ts` (ISO 8601; учитывать Z/UTC) → datetime с таймзоной.
- Обновление существующих видео:
  - Если запись уже есть, не трогаем `channel_added_at` (только если пусто — можно один раз заполнить).

Форматы/таймзоны:
- Парсинг: `datetime.fromisoformat(created_ts.replace('Z', '+00:00'))`.
- Хранение: TIMESTAMP WITH TIME ZONE (UTC). На фронтенде форматируется под локаль.

### 3. API (схемы и эндпоинты)
- Pydantic-схемы (`schemas.py`):
  - В `MovieBase` ничего добавлять не нужно.
  - В схему ответа `Movie` добавить `channel_added_at: Optional[datetime] = None`.
- CRUD и роуты не меняются; сериализация автоматически начнёт возвращать новое поле.
- Сортировки/фильтры (опционально):
  - Можно добавить параметр сортировки `order_by=channel_added_at` в GET /movies (отдельная фича).

### 4. Frontend
- Тип `Movie` в `useMovies.ts` (или центральный тип моделей) расширить полем `channel_added_at?: string`.
- В `MovieList.vue` отобразить дату «публикации на канале»:
  - Иконка: `mdi-calendar-plus`.
  - Источник: `movie.channel_added_at`.
  - Форматирование: локаль `ru-RU`, защита от невалидной даты.
- Подпись/tooltip (по желанию): «Опубликовано на канале: 15 дек 2024».
- Порядок полей в карточке: рядом с длительностью/просмотрами или в отдельной строке.

Пример вставки (template):
```vue
<div v-if="movie.channel_added_at" class="text-caption text-grey">
  <v-icon size="small" class="mr-1">mdi-calendar-plus</v-icon>
  {{ formatDate(movie.channel_added_at) }}
</div>
```

Пример форматтера (script setup):
```ts
const formatDate = (dateString?: string | null): string => {
  if (!dateString) return ''
  const date = new Date(dateString)
  if (isNaN(date.getTime())) return ''
  return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', year: 'numeric' })
}
```

### 5. Тестирование
- Backend:
  - Unit: парсинг `created_ts` в UTC, сериализация `channel_added_at` в ISO8601.
  - Интеграция: запуск `run_api_scraper(limit=1)` с подменённым ответом API; проверить сохранение `channel_added_at`.
- Frontend:
  - Unit: `formatDate` возвращает ожидаемую строку, пустую строку для null/invalid.
  - E2E: карточка видео отображает дату при наличии `channel_added_at`.

### 6. Миграция и откат
- Шаги деплоя:
  1) Применить DDL: добавить поле и индекс.
  2) Задеплоить backend (схемы/скрапер).
  3) Задеплоить frontend.
  4) (Опционально) выполнить бэкфилл.
- Откат: фронтенд игнорирует поле; backend остаётся совместимым (поле nullable). Можно удалить колонку в БД при откате.

### 7. Риски и смягчения
- Неверная интерпретация часовых поясов:
  - Всегда хранить UTC, форматировать на клиенте.
- Старые записи без `channel_added_at`:
  - UI с `v-if`/плейсхолдером; опциональный бэкфилл.
- Дублирование полей даты в UI:
  - Ясные лейблы: «Опубликовано (Rutube)» vs «Добавлено в каталог» (если когда-то понадобится показывать оба).

### 8. Оценка трудоёмкости
- Backend: модель + схемы + скрапер + миграция DDL — 1–2 часа.
- Frontend: тип + отображение + форматтер — 20–30 минут.
- Тесты: 1 час.

## Чек-лист реализации
- [ ] БД: добавить колонку `channel_added_at` (+ индекс).
- [ ] Backend-модель `Movie`: новое поле.
- [ ] Pydantic `schemas.Movie`: добавить `channel_added_at`.
- [ ] Scraper: парсить и сохранять `created_ts` → `channel_added_at`.
- [ ] Frontend: тип модели и UI-отображение.
- [ ] Тесты backend/frontend.
- [ ] (Опционально) Команда бэкфилла для существующих записей.

## Дополнительно (по желанию)
- Эндпоинт фильтрации/сортировки по `channel_added_at` (новые на канале первыми).
- Относительный формат на фронтенде («2 дня назад») при ховере — абсолютная дата.
